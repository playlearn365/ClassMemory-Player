<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ClassMemory Playerï½œèª²å ‚ç…§ç‰‡æ ¼è¨€æ’­æ”¾å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 120px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 4px;
      text-align: center;
      color: #facc15;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      font-size: 14px;
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    @media (min-width: 768px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
    .card {
      background: #0f172a;
      border-radius: 18px;
      border: 1px solid #1e293b;
      padding: 20px;
      box-shadow: 0 20px 35px rgba(0,0,0,0.3);
    }
    .card h2 {
      font-size: 18px;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e2e8f0;
    }
    .upload-area {
      position: relative;
      border-radius: 14px;
      border: 2px dashed #475569;
      padding: 24px 12px;
      text-align: center;
      color: #cbd5f5;
      cursor: pointer;
      transition: 0.2s;
      background: #1e293b;
    }
    .upload-area:hover {
      background: rgba(56, 189, 248, 0.1);
      border-color: #38bdf8;
    }
    .upload-area input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .thumbs {
      margin-top: 12px;
      max-height: 250px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      padding-right: 4px;
    }
    .thumb {
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid transparent;
      background: #000;
    }
    .thumb.has-quote {
      border-color: #facc15;
      box-shadow: 0 0 0 1px rgba(250,204,21,0.3);
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumb-index {
      position: absolute;
      left: 4px;
      bottom: 4px;
      background: rgba(0,0,0,0.7);
      color: #f9fafb;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 4px;
    }

    /* Music Panel */
    .music-panel {
      background: #1e293b;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #334155;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .music-status { font-size: 13px; color: #94a3b8; font-weight: 500; }
    .music-status.ok { color: #4ade80; }
    .music-status.error { color: #f87171; }
    
    /* Inputs */
    textarea, .text-input {
      width: 100%;
      background: #1e293b;
      border-radius: 8px;
      border: 1px solid #334155;
      padding: 10px;
      color: #f1f5f9;
      font-size: 14px;
      outline: none;
      margin-bottom: 10px;
    }
    label { font-size: 13px; color: #94a3b8; display: block; margin-bottom: 4px; }

    /* Buttons */
    .btn {
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      margin-top: 10px;
      transition: 0.2s;
      text-decoration: none; /* For links */
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-green { background: #10b981; color: white; }
    
    /* æ‰‹æ©Ÿå°ˆç”¨ä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ */
    .btn-pink { 
      background: #ec4899; 
      color: white; 
      box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
      display: block;
      text-align: center;
    } 
    .btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn.loading { opacity: 0.7; cursor: wait; }

    /* æ‰‹æ©Ÿæ•™å­¸æç¤ºæ¨£å¼ */
    .mobile-hint {
      margin-top: 15px;
      padding: 12px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      font-size: 13px;
      color: #cbd5f5;
      text-align: left;
      line-height: 1.6;
    }
    .mobile-hint strong { color: #facc15; }

    /* Player Overlay */
    #playerView {
      position: fixed;
      inset: 0;
      background: #000;
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      flex-direction: column;
    }
    #playerView.show { display: flex; }
    #playerImageWrapper {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #playerImage { max-width: 100%; max-height: 100%; object-fit: contain; }
    .quote-layer {
      position: absolute; bottom: 0; width: 100%; padding-bottom: 80px;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      text-align: center; display: flex; justify-content: center;
    }
    .quote-box { background: rgba(0,0,0,0.6); padding: 15px 30px; border-radius: 12px; }
    .quote-box h1 { margin: 0; color: #facc15; font-size: 24px; }
    .controls { position: absolute; bottom: 30px; display: flex; gap: 20px; background: #334155; padding: 10px 30px; border-radius: 50px; }
    .c-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
  </style>
</head>
<body>

<div class="page" id="setupView">
  <h1>ğŸ“¸ ClassMemory Player</h1>
  <p class="subtitle">è€å¸«è«‹ä¸Šå‚³ç…§ç‰‡ï¼ŒéŸ³æ¨‚å·²è‡ªå‹•è¼‰å…¥ã€‚</p>

  <div class="grid">
    <!-- Left: Photos -->
    <div class="card">
      <h2>1. ä¸Šå‚³ç…§ç‰‡ (<span id="photoCount">0</span>)</h2>
      <div class="upload-area">
        <span style="font-size:24px">ğŸ“‚</span><br>
        é»æ“Šé¸æ“‡ç…§ç‰‡
        <input type="file" id="photoInput" accept="image/*" multiple />
      </div>
      <div id="thumbs" class="thumbs"></div>
    </div>

    <!-- Right: Settings -->
    <div class="card">
      <h2>2. è¨­å®š</h2>
      
      <!-- Music Section -->
      <div class="music-panel">
        <span style="font-size:20px">ğŸµ</span>
        <div id="musicStatus" class="music-status">â³ æ­£åœ¨è¼‰å…¥éŸ³æ¨‚ (music.mp3)...</div>
      </div>

      <div style="margin-top:20px;">
        <label>æ ¼è¨€ (ç¬¬1å¼µ)</label>
        <textarea id="q1" rows="1">å¥½çš„é–‹å§‹æ˜¯æˆåŠŸçš„ä¸€åŠ</textarea>
        <label>æ ¼è¨€ (ç¬¬5å¼µ)</label>
        <textarea id="q2" rows="1">ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯</textarea>
        <label>æ ¼è¨€ (ç¬¬10å¼µ)</label>
        <textarea id="q3" rows="1">å­¸è€Œä¸æ€å‰‡ç½”ï¼Œæ€è€Œä¸å­¸å‰‡æ®†</textarea>
        
        <label>ä¸‹è¼‰æª”åï¼ˆå»ºè­°ç”¨è‹±æ–‡ï¼Œä¾‹å¦‚ï¼šxiao1ï¼‰</label>
        <input id="fileName" class="text-input" placeholder="ä¾‹å¦‚ï¼šxiao1.html" />
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" onclick="startPreview()">â–¶ ç·šä¸Šé è¦½</button>
        <button class="btn btn-green" id="exportBtn" onclick="exportForParents()">ğŸ’¾ ä¸‹è¼‰ (çµ¦å®¶é•·)</button>
      </div>
      
      <!-- æ‰‹æ©Ÿè¨­è¨ˆçš„ä¸‹è¼‰å€ -->
      <div id="downloadArea" style="text-align:center; margin-top:10px;"></div>
    </div>
  </div>
</div>

<!-- Player -->
<div id="playerView">
  <div id="playerImageWrapper">
    <img id="playerImage" src="" />
    <div class="quote-layer" id="quoteLayer" style="display:none">
      <div class="quote-box"><h1 id="quoteText"></h1></div>
    </div>
  </div>
  <!-- é è¨­è¼‰å…¥ music.mp3 -->
  <audio id="bgmPlayer" loop></audio>
  <div class="controls">
    <button class="c-btn" onclick="closePlayer()">âœ•</button>
    <button class="c-btn" onclick="togglePlay()" id="ppBtn">âšâš</button>
  </div>
</div>

<script>
// === æ ¸å¿ƒè®Šæ•¸ ===
const MUSIC_FILE_NAME = 'music.mp3'; 
let bgmBlobUrl = null; 
let bgmBase64 = null;  

// âœ… æ–°å¢ï¼šåµæ¸¬æ˜¯ä¸æ˜¯æ‰‹æ©Ÿ / iOS
const ua = navigator.userAgent.toLowerCase();
const isMobile = /iphone|ipad|ipod|android/.test(ua);
const isIOS = /iphone|ipad|ipod/.test(ua);

// DOM
const photoInput = document.getElementById('photoInput');
const thumbs = document.getElementById('thumbs');
const photoCount = document.getElementById('photoCount');
const musicStatus = document.getElementById('musicStatus');
const exportBtn = document.getElementById('exportBtn');
const downloadArea = document.getElementById('downloadArea');
const playerView = document.getElementById('playerView');
const bgmPlayer = document.getElementById('bgmPlayer');
const playerImage = document.getElementById('playerImage');
const quoteLayer = document.getElementById('quoteLayer');
const quoteText = document.getElementById('quoteText');
const ppBtn = document.getElementById('ppBtn');

let photos = [];
let slides = [];
let idx = 0;
let timer = null;
let isPlaying = false;

// === 1. è‡ªå‹•è¼‰å…¥éŸ³æ¨‚ ===
async function loadMusic() {
  try {
    const response = await fetch(MUSIC_FILE_NAME).catch(() => null);
    
    if (!response || !response.ok) {
        throw new Error("Local file fetch failed");
    }
    
    const blob = await response.blob();
    bgmBlobUrl = URL.createObjectURL(blob);
    bgmPlayer.src = bgmBlobUrl;
    
    const reader = new FileReader();
    reader.onloadend = () => {
      bgmBase64 = reader.result;
      musicStatus.innerHTML = `âœ… èƒŒæ™¯éŸ³æ¨‚å·²å°±ç·’ (${MUSIC_FILE_NAME})`;
      musicStatus.className = "music-status ok";
    };
    reader.readAsDataURL(blob);
    
  } catch (error) {
    console.log("Preview mode info: music.mp3 not found nearby (normal in editor).");
    musicStatus.innerHTML = `âš ï¸ é è¦½æ¨¡å¼ï¼šæ‰¾ä¸åˆ° <b>${MUSIC_FILE_NAME}</b><br><span style="font-size:11px">è‹¥å·²ä¸Šå‚³åˆ° GitHub åŒä¸€ç›®éŒ„ï¼Œæ­¤è¨Šæ¯æœƒè‡ªå‹•æ¶ˆå¤±ã€‚</span>`;
    musicStatus.className = "music-status error";
  }
}

window.addEventListener('DOMContentLoaded', loadMusic);

// === 2. ç…§ç‰‡è™•ç† ===
photoInput.addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  
  let count = 0;
  files.forEach(f => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas');
        let w = img.width, h = img.height;
        const max = 1000;
        if (w > max || h > max) { 
          const r = Math.min(max / w, max / h); 
          w *= r; h *= r; 
        }
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        photos.push({ src: c.toDataURL('image/jpeg', 0.8) });
        count++;
        if (count === files.length) renderThumbs();
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(f);
  });
  photoInput.value = '';
});

function renderThumbs() {
  photoCount.innerText = photos.length;
  thumbs.innerHTML = photos.map((p, i) => `
    <div class="thumb ${(i===0||i===4||i===9)?'has-quote':''}">
      <img src="${p.src}">
      <span class="thumb-index">${i+1}</span>
    </div>
  `).join('');
}

// === 3. æ’­æ”¾é‚è¼¯ ===
function getSlides() {
  const q1 = document.getElementById('q1').value;
  const q2 = document.getElementById('q2').value;
  const q3 = document.getElementById('q3').value;
  return photos.map((p, i) => {
    let t = "";
    if (i === 0) t = q1;
    if (i === 4) t = q2;
    if (i === 9) t = q3;
    return { src: p.src, txt: t };
  });
}

function startPreview() {
  if (!photos.length) { 
    alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡ï¼"); 
    return; 
  }
  slides = getSlides();
  idx = 0;
  document.getElementById('setupView').style.display = 'none';
  playerView.classList.add('show');
  isPlaying = true;
  renderSlide();
  
  bgmPlayer.play().catch(e => {
    console.log("Auto-play prevented", e);
  });
  
  ppBtn.innerText = "âšâš";
  startTimer();
}

function closePlayer() {
  isPlaying = false;
  clearInterval(timer);
  bgmPlayer.pause();
  bgmPlayer.currentTime = 0;
  playerView.classList.remove('show');
  document.getElementById('setupView').style.display = 'block';
}

function renderSlide() {
  const s = slides[idx];
  playerImage.src = s.src;
  if (s.txt) { 
    quoteText.innerText = s.txt; 
    quoteLayer.style.display = 'flex'; 
  } else { 
    quoteLayer.style.display = 'none'; 
  }
}

function next() {
  if (idx < slides.length - 1) { 
    idx++; 
    renderSlide(); 
  } else { 
    isPlaying = false; 
    clearInterval(timer); 
    bgmPlayer.pause(); 
    ppBtn.innerText = 'â–¶'; 
  }
}

function togglePlay() {
  isPlaying = !isPlaying;
  ppBtn.innerText = isPlaying ? 'âšâš' : 'â–¶';
  if (isPlaying) { 
    bgmPlayer.play(); 
    startTimer(); 
  } else { 
    bgmPlayer.pause(); 
    clearInterval(timer); 
  }
}

function startTimer() {
  clearInterval(timer);
  timer = setInterval(next, 4000);
}

// === 4. åŒ¯å‡ºé‚è¼¯ï¼ˆé›»è…¦ï¼ç›´æ¥ä¸‹è¼‰ï¼Œæ‰‹æ©Ÿï¼é–‹æ–°åˆ†é  + å„²å­˜æ•™å­¸ï¼‰===
function exportForParents() {
  if (!photos.length) {
    alert("æ²’æœ‰ç…§ç‰‡å¯ä»¥åŒ¯å‡ºï¼");
    return;
  }

  if (!bgmBase64) {
    if (!confirm("âš ï¸ è­¦å‘Šï¼šç›®å‰æ²’æœ‰åµæ¸¬åˆ° music.mp3ï¼ŒåŒ¯å‡ºçš„æª”æ¡ˆå°‡æ²’æœ‰è²éŸ³ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return;
  }

  exportBtn.innerText = "â³ æ‰“åŒ…ä¸­...";
  exportBtn.classList.add("loading");
  exportBtn.disabled = true;

  setTimeout(() => {
    // 1. æª”åè™•ç†
    const rawName = document.getElementById('fileName').value.trim() || 'ClassMemory';
    const safeBase = rawName.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5-]/g, "_") || "ClassMemory";
    const safeName = safeBase.endsWith(".html") ? safeBase : safeBase + ".html";

    // 2. æº–å‚™è³‡æ–™
    const slidesData = JSON.stringify(getSlides());
    const musicData = bgmBase64 || "";

    // 3. è¦çµ¦å®¶é•·çš„ HTML å…§å®¹
    const finalHtml = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${safeName}</title>
<style>
body{margin:0;background:#000;height:100vh;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;display:flex;justify-content:center;align-items:center}
img{max-width:100%;max-height:100%;object-fit:contain;transition:opacity .5s}
.q{position:absolute;bottom:0;width:100%;padding:40px 20px 80px;background:linear-gradient(to top,#000000cc,transparent);text-align:center;display:none}
.box{background:#00000099;padding:15px 30px;border-radius:15px;display:inline-block;backdrop-filter:blur(5px)}
h1{color:#facc15;margin:0;font-size:24px;text-shadow:0 2px 4px #000}
#btn{position:absolute;z-index:10;background:#3b82f6;color:#fff;border:none;padding:15px 40px;border-radius:50px;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(59,130,246,0.5)}
#hint{position:absolute;top:10px;left:0;right:0;color:#e5e7eb;font-size:13px;text-align:center;padding:0 16px;line-height:1.5;background:rgba(0,0,0,0.5);pointer-events:none;}
</style>
</head>
<body>
<div id="hint">ğŸ“Œ æç¤ºï¼šè‹¥æŒ‰éˆ•æ²’åæ‡‰ï¼Œè«‹åœ¨ç€è¦½å™¨å³ä¸Šè§’é¸ã€Œä»¥ Chrome / Safari é–‹å•Ÿã€å†è©¦ä¸€æ¬¡ã€‚</div>
<button id="btn" onclick="start()">â–¶ é–‹å§‹æ’­æ”¾å›é¡§</button>
<img id="img">
<div id="q" class="q"><div class="box"><h1 id="qt"></h1></div></div>
<script>
const S=${slidesData};
const M="${musicData}";
let i=0,t;
const a = M ? new Audio(M) : null;
if(a){a.loop=true;}
const img=document.getElementById('img');
const q=document.getElementById('q');
const qt=document.getElementById('qt');
const btn=document.getElementById('btn');
const hint=document.getElementById('hint');
setTimeout(()=>{if(hint)hint.style.display='none'},5000);
function start(){
  btn.style.display='none';
  if(hint) hint.style.display='none';
  if(a){ a.play().catch(e=>console.log(e)); }
  show();
  t=setInterval(next,4000);
}
function show(){
  const s=S[i];
  img.src=s.src;
  if(s.txt){qt.innerText=s.txt;q.style.display='block';}
  else{q.style.display='none';}
}
function next(){
  if(i<S.length-1){i++;show();}
  else{
    clearInterval(t);
    if(a){a.pause();}
    btn.innerText='â†º é‡çœ‹ä¸€æ¬¡';
    btn.style.display='block';
    i=0;
  }
}
<\/script>
</body>
</html>`;

    // 4. å»ºç«‹ URLï¼šæ¡Œæ©Ÿç”¨ Blobï¼Œæ‰‹æ©Ÿç”¨ data: URLï¼ˆç›¸å®¹æ€§è¼ƒå¥½ï¼‰
    let url;
    if (isMobile) {
      url = "data:text/html;charset=utf-8," + encodeURIComponent(finalHtml);
    } else {
      const blob = new Blob([finalHtml], { type: "text/html" });
      url = URL.createObjectURL(blob);
    }

    // 5. æ¸…ç©ºä¸‹è¼‰å€ï¼Œæº–å‚™æ–°æŒ‰éˆ•
    downloadArea.innerHTML = "";

    // 5-1 æ¡Œæ©Ÿï¼šå˜—è©¦è‡ªå‹•ä¸‹è¼‰
    if (!isMobile) {
      const autoLink = document.createElement("a");
      autoLink.href = url;
      autoLink.download = safeName;
      document.body.appendChild(autoLink);
      autoLink.click();
      document.body.removeChild(autoLink);
    }

    // 5-2 æ‰‹æ©Ÿ / æ¡Œæ©Ÿ å…±åŒçš„ã€Œç²‰ç´…è‰²æŒ‰éˆ•ã€
    const manualBtn = document.createElement("a");
    manualBtn.href = url;
    manualBtn.className = "btn btn-pink";
    manualBtn.innerHTML = `ğŸ“¥ é»æ­¤ä¸‹è¼‰æª”æ¡ˆï¼š${safeName}`;

    if (!isMobile) {
      // æ¡Œæ©Ÿæ”¯æ´ download å±¬æ€§
      manualBtn.download = safeName;
    } else {
      // æ‰‹æ©Ÿï¼šé–‹æ–°åˆ†é ï¼Œè®“ä½¿ç”¨è€…å†æŒ‰ã€Œåˆ†äº« â†’ å„²å­˜ã€
      manualBtn.target = "_blank";
      manualBtn.addEventListener("click", () => {
        if (isIOS) {
          setTimeout(() => {
            alert(
              "iPhone ä½¿ç”¨æ­¥é©Ÿï¼š\n\n" +
              "1. æœƒé–‹å•Ÿä¸€å€‹æ–°çš„ç•«é¢ã€‚\n" +
              "2. åœ¨ç•«é¢ä¸‹æ–¹æŒ‰ã€Œåˆ†äº«ã€åœ–ç¤ºï¼ˆâ¬†ï¸ï¼‰ã€‚\n" +
              "3. é¸ã€Œå„²å­˜åˆ°æª”æ¡ˆã€ï¼Œå³å¯å­˜åˆ°æ‰‹æ©Ÿã€‚"
            );
          }, 800);
        }
      });
    }

    const mobileHint = document.createElement("div");
    mobileHint.className = "mobile-hint";
    mobileHint.innerHTML = `
      <strong>ğŸ“± æ‰‹æ©Ÿä¸‹è¼‰æ•™å­¸ï¼š</strong><br>
      1. é»æ“Šä¸Šæ–¹çš„<strong style="color:#ec4899">ç²‰ç´…è‰²æŒ‰éˆ•</strong>ã€‚<br>
      2. <strong>iPhone (Safari)</strong>ï¼šè‹¥å‡ºç¾é è¦½ï¼Œè«‹é»ä¸‹æ–¹ã€Œåˆ†äº«ã€ğŸ“¤ â†’ã€Œå„²å­˜åˆ°æª”æ¡ˆã€ã€‚<br>
      3. <strong>Android</strong>ï¼šé€šå¸¸æœƒç›´æ¥ä¸‹è¼‰æˆ–å‡ºç¾ã€Œä¸‹è¼‰ã€æé†’ã€‚<br>
      4. <strong>LINE/FB ç€è¦½å™¨</strong>ï¼šè‹¥ç„¡æ³•ä¸‹è¼‰ï¼Œè«‹é»å³ä¸Šè§’é¸å–® â†’ã€Œä½¿ç”¨ Chrome/Safari é–‹å•Ÿã€ã€‚`;

    downloadArea.appendChild(manualBtn);
    downloadArea.appendChild(mobileHint);

    // 6. é‚„åŸæŒ‰éˆ•ç‹€æ…‹
    exportBtn.innerText = "ğŸ’¾ ä¸‹è¼‰ (çµ¦å®¶é•·)";
    exportBtn.classList.remove("loading");
    exportBtn.disabled = false;
  }, 400);
}
</script>
</body>
</html>
