import React, { useState, useEffect, useRef } from 'react';
import { Upload, Play, ChevronLeft, ChevronRight, X, Image as ImageIcon, Save, MonitorPlay } from 'lucide-react';

export default function PhotoQuotePlayer() {
  const [step, setStep] = useState('setup'); // setup, preview
  const [photos, setPhotos] = useState([]);
  const [quotes, setQuotes] = useState({
    start: "å¥½çš„é–‹å§‹æ˜¯æˆåŠŸçš„ä¸€åŠ",
    middle: "ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯",
    end: "å­¸è€Œä¸æ€å‰‡ç½”ï¼Œæ€è€Œä¸å­¸å‰‡æ®†"
  });
  const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [slides, setSlides] = useState([]);

  // è™•ç†åœ–ç‰‡ä¸Šå‚³èˆ‡è½‰ Base64 (ç‚ºäº†æ‰“åŒ…ä¸‹è¼‰åŠŸèƒ½)
  const handleImageUpload = (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    const newPhotos = [];
    let processedCount = 0;

    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (event) => {
        newPhotos.push({
          id: Date.now() + Math.random(),
          src: event.target.result,
          name: file.name
        });
        processedCount++;
        if (processedCount === files.length) {
          setPhotos(prev => [...prev, ...newPhotos]);
        }
      };
      reader.readAsDataURL(file);
    });
  };

  const removePhoto = (id) => {
    setPhotos(photos.filter(p => p.id !== id));
  };

  // ç”Ÿæˆæ’­æ”¾åºåˆ— (ä¿®æ”¹ç‚ºï¼šæ¯å¼µéƒ½æ˜¯ç…§ç‰‡ï¼Œä½†åœ¨ç‰¹å®šç´¢å¼•åŠ ä¸Š overlayQuote å±¬æ€§)
  const generateSlides = () => {
    if (photos.length === 0) return [];
    
    return photos.map((photo, index) => {
        let overlayQuote = null;
        // Index 0 = ç¬¬ 1 å¼µ
        if (index === 0) overlayQuote = quotes.start;
        // Index 4 = ç¬¬ 5 å¼µ
        if (index === 4) overlayQuote = quotes.middle;
        // Index 9 = ç¬¬ 10 å¼µ
        if (index === 9) overlayQuote = quotes.end;

        return {
            src: photo.src,
            overlayQuote: overlayQuote
        };
    });
  };

  const handleStartPlay = () => {
    if (photos.length === 0) {
      alert("è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡ï¼");
      return;
    }
    const generated = generateSlides();
    setSlides(generated);
    setCurrentSlideIndex(0);
    setStep('player');
    setIsPlaying(true);
  };

  // æ’­æ”¾å™¨é‚è¼¯
  useEffect(() => {
    let interval;
    if (isPlaying && step === 'player') {
      interval = setInterval(() => {
        setCurrentSlideIndex(prev => {
          if (prev < slides.length - 1) return prev + 1;
          setIsPlaying(false); // æ’­å®Œåœæ­¢
          return prev;
        });
      }, 4000); // æ¯å¼µ 4 ç§’
    }
    return () => clearInterval(interval);
  }, [isPlaying, step, slides]);

  // æ‰“åŒ…ä¸‹è¼‰åŠŸèƒ½ (ç”Ÿæˆç¨ç«‹ HTML)
  const handleExport = () => {
    if (photos.length === 0) {
      alert("æ²’æœ‰ç…§ç‰‡å¯ä»¥æ‰“åŒ…ï¼");
      return;
    }

    const exportSlides = generateSlides();
    
    // å»ºç«‹ä¸€å€‹æ¥µç°¡çš„ HTML æ¨¡æ¿ (æ›´æ–° CSS ä»¥æ”¯æ´ç–ŠåŠ æ–‡å­—)
    const htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²å ‚ç…§ç‰‡æ’­æ”¾å™¨</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        #container { width: 100%; height: 100%; position: relative; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.8s ease-in-out; pointer-events: none; display: flex; justify-content: center; align-items: center; }
        .slide.active { opacity: 1; pointer-events: auto; }
        
        /* åœ–ç‰‡å®¹å™¨ï¼Œç¢ºä¿å±…ä¸­ä¸”ä¸è®Šå½¢ */
        .img-wrapper { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        img { max-width: 95%; max-height: 95%; object-fit: contain; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        /* æ ¼è¨€ç–ŠåŠ å±¤ */
        .quote-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 60px 20px 100px; /* åº•éƒ¨ç•™ç©ºé–“çµ¦æ§åˆ¶åˆ— */
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
            display: flex;
            justify-content: center;
            text-align: center;
        }
        .quote-text-box {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            padding: 20px 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 80%;
            animation: slideUp 0.8s ease-out;
        }
        .quote-text-box h1 {
            font-size: 2.5rem;
            margin: 0;
            color: #fbbf24;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 30px; backdrop-filter: blur(5px); }
        button { background: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #e2e8f0; transform: scale(1.05); }
        .progress { position: fixed; top: 0; left: 0; height: 5px; background: #fbbf24; transition: width 0.5s; z-index: 100; }
    </style>
</head>
<body>
    <div id="progress" class="progress" style="width: 0%"></div>
    <div id="container"></div>
    <div id="controls">
        <button onclick="prev()">ä¸Šä¸€å¼µ</button>
        <button onclick="togglePlay()" id="playBtn">æš«åœ</button>
        <button onclick="next()">ä¸‹ä¸€å¼µ</button>
    </div>

    <script>
        const slidesData = ${JSON.stringify(exportSlides)};
        let currentIndex = 0;
        let isPlaying = true;
        let timer;
        const container = document.getElementById('container');
        const playBtn = document.getElementById('playBtn');
        const progressBar = document.getElementById('progress');

        function render() {
            container.innerHTML = slidesData.map((slide, index) => {
                const activeClass = index === currentIndex ? 'active' : '';
                
                // æº–å‚™æ ¼è¨€ HTML (å¦‚æœæœ‰)
                let quoteHTML = '';
                if (slide.overlayQuote) {
                    quoteHTML = \`
                        <div class="quote-overlay">
                            <div class="quote-text-box">
                                <h1>\${slide.overlayQuote}</h1>
                            </div>
                        </div>
                    \`;
                }

                // çµ„åˆåœ–ç‰‡å’Œæ ¼è¨€
                return \`
                    <div class="slide \${activeClass}">
                        <div class="img-wrapper">
                            <img src="\${slide.src}" />
                            \${quoteHTML}
                        </div>
                    </div>
                \`;
            }).join('');
            updateProgress();
        }

        function updateProgress() {
            const width = ((currentIndex + 1) / slidesData.length) * 100;
            progressBar.style.width = width + '%';
        }

        function showSlide(index) {
            const domSlides = document.querySelectorAll('.slide');
            domSlides.forEach((s, i) => {
                s.classList.toggle('active', i === index);
            });
            currentIndex = index;
            updateProgress();
        }

        function next() {
            if (currentIndex < slidesData.length - 1) {
                showSlide(currentIndex + 1);
            } else {
                setIsPlaying(false);
            }
        }

        function prev() {
            if (currentIndex > 0) {
                showSlide(currentIndex - 1);
            }
        }

        function togglePlay() {
            setIsPlaying(!isPlaying);
        }

        function setIsPlaying(state) {
            isPlaying = state;
            playBtn.innerText = isPlaying ? "æš«åœ" : "æ’­æ”¾";
            if (isPlaying) {
                if (currentIndex === slidesData.length - 1) {
                    showSlide(0);
                }
                startTimer();
            } else {
                clearInterval(timer);
            }
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                next();
            }, 4000);
        }

        // Init
        render();
        startTimer();
    </script>
</body>
</html>
    `;

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'æˆ‘çš„èª²å ‚æ’­æ”¾å™¨.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const currentSlide = slides[currentSlideIndex];

  return (
    <div className="min-h-screen bg-slate-900 text-slate-100 font-sans">
      {step === 'setup' && (
        <div className="max-w-4xl mx-auto p-6">
          <header className="mb-8 text-center">
            <h1 className="text-3xl font-bold text-yellow-400 mb-2">ğŸ“¸ èª²å ‚ç…§ç‰‡æ ¼è¨€æ’­æ”¾å™¨</h1>
            <p className="text-slate-400">ä¸Šå‚³ç…§ç‰‡ï¼Œè¨­å®šæ ¼è¨€(å°‡é¡¯ç¤ºåœ¨ç¬¬1,5,10å¼µç…§ç‰‡ä¸Š)ï¼Œå³å¯æ’­æ”¾æˆ–ä¸‹è¼‰ã€‚</p>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            {/* å·¦å´ï¼šä¸Šå‚³å€ */}
            <div className="space-y-6">
              <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                  <ImageIcon className="text-blue-400" />
                  1. ä¸Šå‚³ç…§ç‰‡ ({photos.length} å¼µ)
                </h2>
                <div className="relative border-2 border-dashed border-slate-600 rounded-xl p-8 text-center hover:bg-slate-700/50 transition cursor-pointer group">
                  <input 
                    type="file" 
                    multiple 
                    accept="image/*"
                    onChange={handleImageUpload}
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  />
                  <Upload className="mx-auto w-12 h-12 text-slate-500 group-hover:text-blue-400 mb-2 transition" />
                  <p className="text-sm text-slate-400">é»æ“Šæˆ–æ‹–æ‹‰ç…§ç‰‡è‡³æ­¤ (å»ºè­°10å¼µä»¥ä¸Š)</p>
                </div>
                
                {/* é è¦½ç¸®åœ– */}
                {photos.length > 0 && (
                  <div className="mt-4 grid grid-cols-4 gap-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar">
                    {photos.map((p, idx) => {
                      // æ¨™è¨˜å“ªäº›ç…§ç‰‡æœƒæœ‰æ ¼è¨€
                      const hasQuote = idx === 0 || idx === 4 || idx === 9;
                      return (
                        <div key={p.id} className={`relative group aspect-square rounded-md overflow-hidden ${hasQuote ? 'ring-2 ring-yellow-400' : ''}`}>
                          <img src={p.src} alt="preview" className="w-full h-full object-cover" />
                          <button 
                            onClick={() => removePhoto(p.id)}
                            className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition shadow-sm z-10"
                          >
                            <X size={12} />
                          </button>
                          <span className="absolute bottom-1 left-1 bg-black/60 text-[10px] px-1 rounded text-white">
                            {idx + 1} {hasQuote && 'ğŸ’¬'}
                          </span>
                        </div>
                      );
                    })}
                  </div>
                )}
                {photos.length > 0 && <p className="text-xs text-slate-500 mt-2">* é»ƒè‰²æ¡†å’Œ ğŸ’¬ æ¨™è¨˜çš„ç…§ç‰‡å°‡æœƒé¡¯ç¤ºæ ¼è¨€ã€‚</p>}
              </div>
            </div>

            {/* å³å´ï¼šè¨­å®šå€ */}
            <div className="space-y-6">
              <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                  <MonitorPlay className="text-yellow-400" />
                  2. è¨­å®šæ ¼è¨€ (ç–ŠåŠ åœ¨ç…§ç‰‡ä¸Š)
                </h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-slate-400 mb-1">ç¬¬ 1 å¼µç…§ç‰‡æ ¼è¨€</label>
                    <textarea 
                      value={quotes.start}
                      onChange={(e) => setQuotes({...quotes, start: e.target.value})}
                      className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-yellow-400 focus:border-transparent outline-none transition"
                      rows="2"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm text-slate-400 mb-1">ç¬¬ 5 å¼µç…§ç‰‡æ ¼è¨€</label>
                    <textarea 
                      value={quotes.middle}
                      onChange={(e) => setQuotes({...quotes, middle: e.target.value})}
                      className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-yellow-400 focus:border-transparent outline-none transition"
                      rows="2"
                    />
                  </div>

                  <div>
                    <label className="block text-sm text-slate-400 mb-1">ç¬¬ 10 å¼µç…§ç‰‡æ ¼è¨€</label>
                    <textarea 
                      value={quotes.end}
                      onChange={(e) => setQuotes({...quotes, end: e.target.value})}
                      className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-yellow-400 focus:border-transparent outline-none transition"
                      rows="2"
                    />
                  </div>
                </div>
              </div>

              {/* æ“ä½œæŒ‰éˆ• */}
              <div className="grid grid-cols-2 gap-4">
                <button 
                  onClick={handleStartPlay}
                  className="bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition shadow-lg shadow-blue-900/50"
                >
                  <Play size={20} />
                  ç·šä¸Šé è¦½æ’­æ”¾
                </button>
                <button 
                  onClick={handleExport}
                  className="bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition shadow-lg shadow-emerald-900/50"
                >
                  <Save size={20} />
                  æ‰“åŒ…ä¸‹è¼‰ HTML
                </button>
              </div>
              <p className="text-xs text-center text-slate-500 mt-2">
                *ã€Œæ‰“åŒ…ä¸‹è¼‰ã€æœƒç”¢ç”Ÿä¸€å€‹åŒ…å«æ‰€æœ‰ç…§ç‰‡çš„ç¨ç«‹æª”æ¡ˆï¼Œæ–¹ä¾¿æ”œå¸¶è‡³ç„¡ç¶²è·¯ç’°å¢ƒä½¿ç”¨ã€‚
              </p>
            </div>
          </div>
        </div>
      )}

      {/* æ’­æ”¾æ¨¡å¼ */}
      {step === 'player' && currentSlide && (
        <div className="fixed inset-0 bg-black flex flex-col items-center justify-center z-50">
          {/* é€²åº¦æ¢ */}
          <div className="absolute top-0 left-0 h-1 bg-yellow-500 transition-all duration-500" style={{ width: `${((currentSlideIndex + 1) / slides.length) * 100}%` }}></div>

          {/* å…§å®¹é¡¯ç¤ºå€ (ä¿®æ”¹ç‚ºç…§ç‰‡+ç–ŠåŠ å±¤) */}
          <div className="w-full h-full max-w-7xl max-h-[90vh] flex items-center justify-center p-4 relative group">
             <img 
               src={currentSlide.src} 
               alt="slide" 
               className="max-w-full max-h-full object-contain rounded shadow-2xl animate-fade-in"
             />

             {/* æ ¼è¨€ç–ŠåŠ å±¤ (å¦‚æœæœ‰çš„è©±) */}
             {currentSlide.overlayQuote && (
               <div className="absolute inset-0 flex items-end justify-center pb-24 md:pb-20 bg-gradient-to-t from-black/90 via-black/30 to-transparent animate-fade-in">
                 <div className="bg-black/50 backdrop-blur-md p-6 md:p-8 rounded-3xl border border-white/20 max-w-4xl text-center mx-4 transform transition-all duration-700 translate-y-0 opacity-100">
                   <h1 className="text-2xl md:text-4xl font-bold text-yellow-400 leading-tight drop-shadow-lg">
                     {currentSlide.overlayQuote}
                   </h1>
                 </div>
               </div>
             )}
          </div>

          {/* æ§åˆ¶åˆ— */}
          <div className="absolute bottom-8 flex items-center gap-6 bg-slate-900/80 backdrop-blur px-6 py-3 rounded-full border border-white/10 z-50">
             <button 
              onClick={() => setStep('setup')}
              className="text-slate-400 hover:text-white transition p-2"
              title="é›¢é–‹"
             >
               <X size={24} />
             </button>
             
             <div className="h-6 w-[1px] bg-white/20"></div>

             <button onClick={() => setCurrentSlideIndex(Math.max(0, currentSlideIndex - 1))} className="text-white hover:text-yellow-400 transition">
               <ChevronLeft size={32} />
             </button>
             
             <button 
              onClick={() => setIsPlaying(!isPlaying)}
              className="bg-yellow-500 hover:bg-yellow-400 text-black rounded-full p-3 transition transform hover:scale-105"
             >
               {isPlaying ? <span className="font-bold text-xs block w-6">PAUSE</span> : <Play size={24} fill="currentColor" />}
             </button>

             <button onClick={() => setCurrentSlideIndex(Math.min(slides.length - 1, currentSlideIndex + 1))} className="text-white hover:text-yellow-400 transition">
               <ChevronRight size={32} />
             </button>
             
             <div className="h-6 w-[1px] bg-white/20"></div>

             <span className="text-slate-400 font-mono text-sm">
               {currentSlideIndex + 1} / {slides.length}
             </span>
          </div>
        </div>
      )}
      
      <style>{`
        .animate-fade-in {
          animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        /* è‡ªå®šç¾©æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar {
          width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: #1e293b; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #475569; 
          border-radius: 3px;
        }
      `}</style>
    </div>
  );
}
