<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ClassMemory Playerï½œèª²å ‚ç…§ç‰‡æ ¼è¨€æ’­æ”¾å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 4px;
      text-align: center;
      color: #facc15;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      font-size: 14px;
      margin-bottom: 24px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    @media (min-width: 768px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
    .card {
      background: #020617;
      border-radius: 18px;
      border: 1px solid #1e293b;
      padding: 20px;
      box-shadow: 0 20px 35px rgba(15,23,42,0.8);
    }
    .card h2 {
      font-size: 18px;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .small {
      font-size: 12px;
      color: #94a3b8;
    }
    .upload-area {
      position: relative;
      border-radius: 14px;
      border: 2px dashed #475569;
      padding: 24px 12px;
      text-align: center;
      color: #cbd5f5;
      cursor: pointer;
      transition: 0.2s;
    }
    .upload-area:hover {
      background: rgba(30,64,175,0.15);
      border-color: #38bdf8;
    }
    .upload-area input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .thumbs {
      margin-top: 12px;
      max-height: 190px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      padding-right: 4px;
    }
    .thumbs::-webkit-scrollbar { width: 6px; }
    .thumbs::-webkit-scrollbar-track { background: #0f172a; }
    .thumbs::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }
    .thumb {
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid transparent;
    }
    .thumb.has-quote {
      border-color: #facc15;
      box-shadow: 0 0 0 1px rgba(250,204,21,0.5);
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .thumb-index {
      position: absolute;
      left: 4px;
      bottom: 4px;
      background: rgba(0,0,0,0.7);
      color: #f9fafb;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 999px;
    }
    .thumb button {
      position: absolute;
      right: 4px;
      top: 4px;
      border: none;
      background: #ef4444;
      color: white;
      border-radius: 999px;
      width: 18px;
      height: 18px;
      font-size: 11px;
      cursor: pointer;
      opacity: 0;
      transition: 0.15s;
    }
    .thumb:hover button { opacity: 1; }

    textarea {
      width: 100%;
      resize: vertical;
      min-height: 48px;
      max-height: 120px;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
      transition: 0.2s;
    }
    textarea:focus {
      border-color: #facc15;
      box-shadow: 0 0 0 1px rgba(250,204,21,0.5);
    }
    label { font-size: 13px; color: #cbd5f5; display: block; margin-bottom: 4px; }

    .text-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px 12px;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      transition: 0.2s;
    }
    .text-input::placeholder { color: #64748b; }
    .text-input:focus {
      border-color: #facc15;
      box-shadow: 0 0 0 1px rgba(250,204,21,0.5);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: 0.18s;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
      box-shadow: 0 10px 25px rgba(37,99,235,0.5);
    }
    .btn-primary:hover { background: #3b82f6; transform: translateY(-1px); }
    .btn-green {
      background: #059669;
      color: white;
      box-shadow: 0 10px 25px rgba(5,150,105,0.5);
    }
    .btn-green:hover { background: #10b981; transform: translateY(-1px); }

    .hint {
      margin-top: 4px;
      text-align: center;
      font-size: 11px;
      color: #64748b;
    }

    /* æ’­æ”¾å™¨è¦†è“‹å±¤ */
    #playerView {
      position: fixed;
      inset: 0;
      background: #000;
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      flex-direction: column;
    }
    #playerView.show { display: flex; }
    #playerImageWrapper {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 1120px;
      max-height: 90vh;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #playerImage {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.9);
      animation: fadeIn 0.8s ease-in-out;
    }
    .quote-layer {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 88px;
      background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.4), transparent);
      animation: fadeIn 0.8s ease-in-out;
    }
    .quote-box {
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      padding: 18px 28px;
      border-radius: 20px;
      border: 1px solid rgba(248,250,252,0.2);
      max-width: 80%;
      text-align: center;
      transform: translateY(0);
      opacity: 1;
    }
    .quote-box h1 {
      margin: 0;
      font-size: 22px;
      color: #facc15;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
    }
    @media (min-width: 768px) {
      .quote-box h1 { font-size: 30px; }
    }

    #progressBar {
      position: absolute;
      left: 0;
      top: 0;
      height: 4px;
      background: #facc15;
      width: 0%;
      transition: width 0.4s;
    }

    .player-controls {
      position: absolute;
      bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(15,23,42,0.9);
      padding: 8px 18px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      backdrop-filter: blur(10px);
    }
    .player-btn {
      border: none;
      background: none;
      color: #e5e7eb;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 18px;
      transition: 0.16s;
    }
    .player-btn:hover { color: #facc15; }
    .player-main {
      border-radius: 999px;
      background: #facc15;
      color: #111827;
      padding: 8px 16px;
      font-weight: 700;
      font-size: 13px;
    }
    .divider {
      width: 1px;
      height: 24px;
      background: rgba(148,163,184,0.4);
    }
    .counter {
      font-size: 12px;
      color: #9ca3af;
      min-width: 70px;
      text-align: right;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="page" id="setupView">
    <h1>ğŸ“¸ ClassMemory Player</h1>
    <p class="subtitle">ä¸Šå‚³èª²å ‚ç…§ç‰‡ï¼Œè¨­å®šæ ¼è¨€èˆ‡èƒŒæ™¯éŸ³æ¨‚ï¼ˆç¬¬ 1ã€5ã€10 å¼µæœ‰æ ¼è¨€ï¼‰ï¼Œå³å¯æ’­æ”¾æˆ–ä¸‹è¼‰æˆå¯ä»¥å‚³çµ¦å®¶é•·çš„æ’­æ”¾å™¨ã€‚</p>

    <div class="grid">
      <!-- å·¦ï¼šä¸Šå‚³ç…§ç‰‡ -->
      <div class="card">
        <h2>1. ä¸Šå‚³ç…§ç‰‡ï¼ˆ<span id="photoCount">0</span> å¼µï¼‰</h2>
        <div class="upload-area">
          é»æ“Šæˆ–æ‹–æ‹‰ç…§ç‰‡è‡³æ­¤ï¼ˆå»ºè­° 10 å¼µä»¥ä¸Šï¼‰
          <input type="file" id="photoInput" accept="image/*" multiple />
        </div>
        <div id="thumbs" class="thumbs"></div>
        <p class="small">ï¼Šæœ‰é»ƒè‰²æ¡†èˆ‡ ğŸ’¬ æ¨™è¨˜çš„ç…§ç‰‡ï¼Œæ’­æ”¾æ™‚æœƒé¡¯ç¤ºæ ¼è¨€ã€‚ï¼ˆåœ–ç‰‡æœƒè‡ªå‹•å£“ç¸®ï¼Œè®“å®¶é•·æ‰‹æ©Ÿæ¯”è¼ƒå¥½é–‹å•Ÿï¼‰</p>
      </div>

      <!-- å³ï¼šæ ¼è¨€ + éŸ³æ¨‚ + æª”å -->
      <div class="card">
        <h2>2. è¨­å®šæ ¼è¨€ã€èƒŒæ™¯éŸ³æ¨‚èˆ‡æª”å</h2>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div>
            <label>ç¬¬ 1 å¼µç…§ç‰‡æ ¼è¨€</label>
            <textarea id="quoteStart">å¥½çš„é–‹å§‹æ˜¯æˆåŠŸçš„ä¸€åŠ</textarea>
          </div>
          <div>
            <label>ç¬¬ 5 å¼µç…§ç‰‡æ ¼è¨€</label>
            <textarea id="quoteMiddle">ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯</textarea>
          </div>
          <div>
            <label>ç¬¬ 10 å¼µç…§ç‰‡æ ¼è¨€</label>
            <textarea id="quoteEnd">å­¸è€Œä¸æ€å‰‡ç½”ï¼Œæ€è€Œä¸å­¸å‰‡æ®†</textarea>
          </div>

          <div>
            <label>èƒŒæ™¯éŸ³æ¨‚ï¼ˆå¯é¸ï¼Œæœ€å¤š 3 é¦–ï¼‰</label>
            <input type="file" id="bgmInput" accept="audio/*" multiple />
            <p class="small">ï¼Šå¯ä¸Šå‚³æœ€å¤š 3 é¦– mp3/m4aï¼Œç„¶å¾Œåœ¨ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡æœ¬æ¬¡è¦ä½¿ç”¨å“ªä¸€é¦–ã€‚</p>
            <select id="bgmSelect" class="text-input">
              <option value="">ï¼ˆä¸ä½¿ç”¨èƒŒæ™¯éŸ³æ¨‚ï¼‰</option>
            </select>
          </div>

          <div>
            <label>çµ¦å®¶é•·çš„æª”æ¡ˆåç¨±ï¼ˆé¸å¡«ï¼‰</label>
            <input
              id="fileNameInput"
              class="text-input"
              placeholder="ä¾‹å¦‚ï¼šå°å¤ªé™½ç­-112å­¸å¹´åº¦æˆæœæ’­æ”¾.html"
            />
            <p class="small">è‹¥æœªå¡«å¯«ï¼Œé è¨­æª”åç‚ºï¼šClassMemory-Player.html</p>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="previewBtn">â–¶ ç·šä¸Šé è¦½æ’­æ”¾</button>
          <button class="btn btn-green" id="exportBtn">ğŸ’¾ ä¸‹è¼‰çµ¦å®¶é•·çš„æ’­æ”¾å™¨</button>
        </div>

        <!-- æ¸…é™¤æœ¬æ¬¡è¨­å®š -->
        <div style="margin-top:8px;text-align:right;">
          <button
            id="resetBtn"
            class="btn"
            style="background:#0f172a;color:#e5e7eb;padding:8px 14px;font-size:12px;box-shadow:none;"
          >
            ğŸ§¹ æ¸…é™¤æœ¬æ¬¡è¨­å®š
          </button>
        </div>

        <!-- æ‰‹æ©Ÿä¸‹è¼‰æç¤ºå€ -->
        <div id="downloadArea" class="small" style="margin-top:6px;text-align:center;"></div>

        <p class="hint">ï¼Šè‹¥åœ¨æ‰‹æ©Ÿä¸Šï¼ŒæŒ‰ä¸‹ã€Œä¸‹è¼‰ã€å¾Œï¼Œè«‹é»æ“Šä¸Šæ–¹å‡ºç¾çš„ç¶ è‰²é€£çµä¸‹è¼‰æª”æ¡ˆã€‚</p>
      </div>
    </div>
  </div>

  <!-- æ’­æ”¾å™¨è¦†è“‹å±¤ -->
  <div id="playerView">
    <div id="progressBar"></div>
    <div id="playerImageWrapper">
      <img id="playerImage" src="" alt="slide" />
      <div id="quoteLayer" class="quote-layer" style="display:none;">
        <div class="quote-box">
          <h1 id="quoteText"></h1>
        </div>
      </div>
      <div class="player-controls">
        <button class="player-btn" id="exitBtn" title="è¿”å›ç·¨è¼¯">âœ•</button>
        <div class="divider"></div>
        <button class="player-btn" id="prevBtn">âŸ¨</button>
        <button class="player-btn player-main" id="playPauseBtn">æš«åœ</button>
        <button class="player-btn" id="nextBtn">âŸ©</button>
        <div class="divider"></div>
        <div class="counter" id="counterText">0 / 0</div>
      </div>
    </div>
  </div>

  <script>
    // --------- åˆå§‹é è¨­æ ¼è¨€ ---------
    const DEFAULT_QUOTE_START = 'å¥½çš„é–‹å§‹æ˜¯æˆåŠŸçš„ä¸€åŠ';
    const DEFAULT_QUOTE_MIDDLE = 'ä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯';
    const DEFAULT_QUOTE_END = 'å­¸è€Œä¸æ€å‰‡ç½”ï¼Œæ€è€Œä¸å­¸å‰‡æ®†';

    // --------- ç‹€æ…‹ ---------
    const photos = []; // {id, src, name}
    let slides = [];   // {src, overlayQuote}
    let currentIndex = 0;
    let isPlaying = false;
    let timer = null;

    // èƒŒæ™¯éŸ³æ¨‚ï¼šæœ€å¤š 3 é¦–
    const bgmList = []; // {id, name, src(dataURL)}
    let bgmAudio = null;
    let lastDownloadUrl = null;

    const photoInput = document.getElementById('photoInput');
    const thumbsEl = document.getElementById('thumbs');
    const photoCountEl = document.getElementById('photoCount');

    const quoteStartEl = document.getElementById('quoteStart');
    const quoteMiddleEl = document.getElementById('quoteMiddle');
    const quoteEndEl = document.getElementById('quoteEnd');

    const bgmInput = document.getElementById('bgmInput');
    const bgmSelect = document.getElementById('bgmSelect');

    const fileNameInput = document.getElementById('fileNameInput');
    const downloadArea = document.getElementById('downloadArea');

    const previewBtn = document.getElementById('previewBtn');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');

    const playerView = document.getElementById('playerView');
    const setupView = document.getElementById('setupView');
    const playerImage = document.getElementById('playerImage');
    const quoteLayer = document.getElementById('quoteLayer');
    const quoteText = document.getElementById('quoteText');
    const progressBar = document.getElementById('progressBar');
    const counterText = document.getElementById('counterText');

    const exitBtn = document.getElementById('exitBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');

    // --------- å£“ç¸®åœ–ç‰‡ï¼ˆæ–¹æ¡ˆ 2ï¼šç”¨ canvas é™å°ºå¯¸ï¼†base64ï¼‰ ---------
    function compressImage(file, callback) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const maxW = 1600;
          const maxH = 1600;
          let { width, height } = img;
          if (width > maxW || height > maxH) {
            const ratio = Math.min(maxW / width, maxH / height);
            width = Math.round(width * ratio);
            height = Math.round(height * ratio);
          }
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          const quality = 0.8;
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          callback(dataUrl);
        };
        img.onerror = () => {
          // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå°±ç”¨åŸå§‹è³‡æ–™
          callback(ev.target.result);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    // --------- ä¸Šå‚³ç…§ç‰‡ ---------
    photoInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      let processed = 0;
      files.forEach(file => {
        compressImage(file, (dataUrl) => {
          photos.push({
            id: Date.now() + Math.random(),
            src: dataUrl,
            name: file.name
          });
          processed++;
          if (processed === files.length) {
            renderThumbs();
          }
        });
      });

      photoInput.value = '';
    });

    function renderThumbs() {
      photoCountEl.textContent = photos.length.toString();
      thumbsEl.innerHTML = '';
      photos.forEach((p, idx) => {
        const hasQuote = idx === 0 || idx === 4 || idx === 9;
        const div = document.createElement('div');
        div.className = 'thumb' + (hasQuote ? ' has-quote' : '');
        const img = document.createElement('img');
        img.src = p.src;
        div.appendChild(img);

        const badge = document.createElement('span');
        badge.className = 'thumb-index';
        badge.textContent = (idx+1) + (hasQuote ? ' ğŸ’¬' : '');
        div.appendChild(badge);

        const btn = document.createElement('button');
        btn.textContent = 'Ã—';
        btn.addEventListener('click', () => {
          const i = photos.findIndex(ph => ph.id === p.id);
          if (i >= 0) {
            photos.splice(i, 1);
            renderThumbs();
          }
        });
        div.appendChild(btn);
        thumbsEl.appendChild(div);
      });
    }

    // --------- ä¸Šå‚³èƒŒæ™¯éŸ³æ¨‚ï¼ˆæœ€å¤š 3 é¦–ï¼‰ ---------
    bgmInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const remaining = 3 - bgmList.length;
      if (remaining <= 0) {
        alert('å·²ç¶“æœ‰ 3 é¦–èƒŒæ™¯éŸ³æ¨‚ï¼Œå¦‚éœ€æ›´æ›å¯ä»¥å…ˆæ¸…é™¤æœ¬æ¬¡è¨­å®šã€‚');
        bgmInput.value = '';
        return;
      }

      const toLoad = files.slice(0, remaining);
      let processed = 0;
      toLoad.forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          bgmList.push({
            id: Date.now() + Math.random(),
            name: file.name,
            src: ev.target.result
          });
          processed++;
          if (processed === toLoad.length) {
            refreshBgmSelect();
          }
        };
        reader.readAsDataURL(file);
      });

      bgmInput.value = '';
    });

    function refreshBgmSelect() {
      bgmSelect.innerHTML = '<option value="">ï¼ˆä¸ä½¿ç”¨èƒŒæ™¯éŸ³æ¨‚ï¼‰</option>';
      bgmList.forEach((bgm, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.textContent = 'ğŸµ ' + bgm.name;
        bgmSelect.appendChild(opt);
      });
    }

    // --------- ç”¢ç”Ÿæ’­æ”¾åºåˆ— ---------
    function generateSlides() {
      const qStart = quoteStartEl.value.trim();
      const qMiddle = quoteMiddleEl.value.trim();
      const qEnd = quoteEndEl.value.trim();

      return photos.map((p, idx) => {
        let overlayQuote = null;
        if (idx === 0 && qStart) overlayQuote = qStart;
        if (idx === 4 && qMiddle) overlayQuote = qMiddle;
        if (idx === 9 && qEnd) overlayQuote = qEnd;
        return { src: p.src, overlayQuote };
      });
    }

    // --------- æ’­æ”¾å™¨ï¼ˆé è¦½ï¼‰ ---------
    function openPlayer() {
      if (!photos.length) {
        alert('è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡ï¼');
        return;
      }
      slides = generateSlides();
      currentIndex = 0;
      isPlaying = true;
      setupView.style.display = 'none';
      playerView.classList.add('show');
      playPauseBtn.textContent = 'æš«åœ';
      renderSlide();
      setupBgmForPreview();
      startTimer();
    }

    function closePlayer() {
      isPlaying = false;
      clearInterval(timer);
      if (bgmAudio) {
        bgmAudio.pause();
        bgmAudio = null;
      }
      playerView.classList.remove('show');
      setupView.style.display = 'block';
    }

    function renderSlide() {
      if (!slides.length) return;
      const slide = slides[currentIndex];
      playerImage.src = slide.src;
      if (slide.overlayQuote) {
        quoteLayer.style.display = 'flex';
        quoteText.textContent = slide.overlayQuote;
      } else {
        quoteLayer.style.display = 'none';
      }
      const progress = ((currentIndex + 1) / slides.length) * 100;
      progressBar.style.width = progress + '%';
      counterText.textContent = (currentIndex+1) + ' / ' + slides.length;
    }

    function nextSlide() {
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        renderSlide();
      } else {
        isPlaying = false;
        clearInterval(timer);
        playPauseBtn.textContent = 'æ’­æ”¾';
      }
    }

    function prevSlide() {
      if (currentIndex > 0) {
        currentIndex--;
        renderSlide();
      }
    }

    function startTimer() {
      clearInterval(timer);
      if (!isPlaying) return;
      timer = setInterval(() => {
        nextSlide();
      }, 4000);
    }

    function togglePlay() {
      isPlaying = !isPlaying;
      playPauseBtn.textContent = isPlaying ? 'æš«åœ' : 'æ’­æ”¾';
      if (isPlaying) {
        if (currentIndex === slides.length - 1) {
          currentIndex = 0;
          renderSlide();
        }
        startTimer();
        if (bgmAudio && bgmAudio.paused) {
          bgmAudio.play().catch(() => {});
        }
      } else {
        clearInterval(timer);
        if (bgmAudio) {
          bgmAudio.pause();
        }
      }
    }

    function setupBgmForPreview() {
      if (bgmAudio) {
        bgmAudio.pause();
        bgmAudio = null;
      }
      const selectedIndex = bgmSelect.value;
      if (selectedIndex === '') return;
      const bgm = bgmList[Number(selectedIndex)];
      if (!bgm) return;

      bgmAudio = new Audio(bgm.src);
      bgmAudio.loop = true;
      bgmAudio.volume = 0.5;
      const playPromise = bgmAudio.play();
      if (playPromise && playPromise.catch) {
        playPromise.catch(() => {
          const unlock = () => {
            bgmAudio.play().catch(() => {});
            document.removeEventListener('click', unlock);
            document.removeEventListener('touchstart', unlock);
          };
          document.addEventListener('click', unlock);
          document.addEventListener('touchstart', unlock);
        });
      }
    }

    // --------- æ¸…é™¤æœ¬æ¬¡è¨­å®šï¼ˆä¿ç•™é è¨­æ ¼è¨€ï¼‰ ---------
    function resetAll() {
      // æ¸…ç…§ç‰‡
      photos.length = 0;
      renderThumbs();

      // æ ¼è¨€å›é è¨­
      quoteStartEl.value = DEFAULT_QUOTE_START;
      quoteMiddleEl.value = DEFAULT_QUOTE_MIDDLE;
      quoteEndEl.value = DEFAULT_QUOTE_END;

      // æ¸…æª”å
      fileNameInput.value = '';

      // æ¸…èƒŒæ™¯éŸ³æ¨‚
      bgmList.length = 0;
      refreshBgmSelect();
      if (bgmAudio) {
        bgmAudio.pause();
        bgmAudio = null;
      }

      // å›åˆ°ç·¨è¼¯ç•«é¢
      isPlaying = false;
      clearInterval(timer);
      playerView.classList.remove('show');
      setupView.style.display = 'block';

      progressBar.style.width = '0%';
      counterText.textContent = '0 / 0';
      downloadArea.innerHTML = '';
    }

    // --------- åŒ¯å‡º HTMLï¼ˆçµ¦å®¶é•·ï¼‰ ---------
    function exportHtml() {
      if (!photos.length) {
        alert('æ²’æœ‰ç…§ç‰‡å¯ä»¥æ‰“åŒ…ï¼');
        return;
      }
      const exportSlides = generateSlides();

      // æº–å‚™èƒŒæ™¯éŸ³æ¨‚ï¼ˆåªå¸¶å‡ºç›®å‰é¸çš„é‚£ä¸€é¦–ï¼‰
      let bgmDataUrl = '';
      const selectedIndex = bgmSelect.value;
      if (selectedIndex !== '') {
        const bgm = bgmList[Number(selectedIndex)];
        if (bgm) {
          bgmDataUrl = bgm.src;
        }
      }
      const bgmSrcLiteral = JSON.stringify(bgmDataUrl);

      // æº–å‚™æª”å
      const rawName = (fileNameInput.value || '').trim();
      let fileName = rawName || 'ClassMemory-Player';
      if (!fileName.toLowerCase().endsWith('.html')) {
        fileName += '.html';
      }
      const safeTitle = fileName.replace(/</g, '&lt;').replace(/>/g, '&gt;');

      const htmlContent = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>${safeTitle}</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin: 0; background: #000; color: white; font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
#container { width: 100%; height: 100%; position: relative; }
.slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.8s ease-in-out; pointer-events: none; display: flex; justify-content: center; align-items: center; }
.slide.active { opacity: 1; pointer-events: auto; }
.img-wrapper { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
img { max-width: 95%; max-height: 95%; object-fit: contain; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.quote-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 60px 20px 100px; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%); display: flex; justify-content: center; text-align: center; }
.quote-text-box { background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); padding: 20px 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); max-width: 80%; animation: slideUp 0.8s ease-out; }
.quote-text-box h1 { font-size: 2.1rem; margin: 0; color: #fbbf24; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
#controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 30px; backdrop-filter: blur(5px); }
button { background: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; }
button:hover { background: #e2e8f0; transform: scale(1.05); }
.progress { position: fixed; top: 0; left: 0; height: 5px; background: #fbbf24; transition: width 0.5s; z-index: 100; }
.hint { position: fixed; top: 8px; right: 8px; font-size: 11px; color: #e5e7eb; opacity: 0.8; }
</style>
</head>
<body>
<div class="hint">è‹¥è½ä¸åˆ°éŸ³æ¨‚ï¼Œè«‹å…ˆé»ä¸€ä¸‹ç•«é¢ä»¥å•Ÿå‹•æ’­æ”¾</div>
<div id="progress" class="progress" style="width:0%"></div>
<div id="container"></div>
<div id="controls">
  <button onclick="prev()">ä¸Šä¸€å¼µ</button>
  <button onclick="togglePlay()" id="playBtn">æš«åœ</button>
  <button onclick="next()">ä¸‹ä¸€å¼µ</button>
</div>
<script>
const slidesData = ${JSON.stringify(exportSlides)};
const bgmSrc = ${bgmSrcLiteral};
let currentIndex = 0;
let isPlaying = true;
let timer;
let bgmAudio = null;

const container = document.getElementById('container');
const playBtn = document.getElementById('playBtn');
const progressBar = document.getElementById('progress');

function setupBgm() {
  if (!bgmSrc) return;
  bgmAudio = new Audio(bgmSrc);
  bgmAudio.loop = true;
  bgmAudio.volume = 0.5;
  const start = () => {
    bgmAudio.play().catch(()=>{});
    document.removeEventListener('click', start);
    document.removeEventListener('touchstart', start);
  };
  const p = bgmAudio.play();
  if (p && p.catch) {
    p.catch(() => {
      document.addEventListener('click', start);
      document.addEventListener('touchstart', start);
    });
  }
}

function render() {
  container.innerHTML = slidesData.map((slide, index) => {
    const activeClass = index === currentIndex ? 'active' : '';
    let quoteHTML = '';
    if (slide.overlayQuote) {
      quoteHTML = '<div class="quote-overlay"><div class="quote-text-box"><h1>' + slide.overlayQuote + '</h1></div></div>';
    }
    return '<div class="slide ' + activeClass + '"><div class="img-wrapper"><img src="' + slide.src + '" />' + quoteHTML + '</div></div>';
  }).join('');
  updateProgress();
}
function updateProgress() {
  const width = ((currentIndex + 1) / slidesData.length) * 100;
  progressBar.style.width = width + '%';
}
function showSlide(index) {
  const domSlides = document.querySelectorAll('.slide');
  domSlides.forEach((s, i) => {
    s.classList.toggle('active', i === index);
  });
  currentIndex = index;
  updateProgress();
}
function next() {
  if (currentIndex < slidesData.length - 1) {
    showSlide(currentIndex + 1);
  } else {
    setIsPlaying(false);
  }
}
function prev() {
  if (currentIndex > 0) {
    showSlide(currentIndex - 1);
  }
}
function togglePlay() {
  setIsPlaying(!isPlaying);
}
function setIsPlaying(state) {
  isPlaying = state;
  playBtn.innerText = isPlaying ? "æš«åœ" : "æ’­æ”¾";
  if (isPlaying) {
    if (currentIndex === slidesData.length - 1) {
      showSlide(0);
    }
    startTimer();
    if (bgmAudio && bgmAudio.paused) {
      bgmAudio.play().catch(()=>{});
    }
  } else {
    clearInterval(timer);
    if (bgmAudio) {
      bgmAudio.pause();
    }
  }
}
function startTimer() {
  clearInterval(timer);
  timer = setInterval(() => { next(); }, 4000);
}

render();
setupBgm();
startTimer();
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowRight') next();
  if (e.key === 'ArrowLeft') prev();
  if (e.key === ' ') { e.preventDefault(); togglePlay(); }
});
<\/script>
</body>
</html>`;

      if (lastDownloadUrl) {
        URL.revokeObjectURL(lastDownloadUrl);
        lastDownloadUrl = null;
      }

      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      lastDownloadUrl = url;

      // æ‰‹æ©Ÿå‹å–„ï¼šåœ¨ç•«é¢ä¸Šé¡¯ç¤ºä¸€å€‹æ˜é¡¯é€£çµï¼Œè«‹è€å¸«/å®¶é•·è‡ªè¡Œé»æ“Šä¸‹è¼‰
      downloadArea.innerHTML = '';
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      link.textContent = 'ğŸ‘‰ æª”æ¡ˆå·²æº–å‚™å¥½ï¼Œè«‹é»é€™è£¡ä¸‹è¼‰ï¼š' + fileName;
      link.style.color = '#4ade80';
      link.style.textDecoration = 'underline';
      link.style.fontWeight = '600';
      downloadArea.appendChild(link);

      // æ¡Œæ©Ÿä¸Šä»å˜—è©¦è‡ªå‹•è§¸ç™¼ä¸‹è¼‰ï¼ˆæ–¹ä¾¿è€å¸«ï¼‰
      link.click();
    }

    // --------- ç¶å®šäº‹ä»¶ ---------
    previewBtn.addEventListener('click', openPlayer);
    exportBtn.addEventListener('click', exportHtml);
    resetBtn.addEventListener('click', resetAll);
    exitBtn.addEventListener('click', closePlayer);
    prevBtn.addEventListener('click', prevSlide);
    nextBtn.addEventListener('click', nextSlide);
    playPauseBtn.addEventListener('click', togglePlay);

    // éµç›¤æ§åˆ¶ï¼ˆåƒ…åœ¨é è¦½æ’­æ”¾æ™‚ç”Ÿæ•ˆï¼‰
    document.addEventListener('keydown', (e) => {
      if (!playerView.classList.contains('show')) return;
      if (e.key === 'ArrowRight') nextSlide();
      if (e.key === 'ArrowLeft') prevSlide();
      if (e.key === ' ') {
        e.preventDefault();
        togglePlay();
      }
      if (e.key === 'Escape') closePlayer();
    });
  </script>
</body>
</html>
